#!/usr/bin/env python3

from datetime import datetime
from typing import List
from .features.ethercat import *
from .features.zwave import *
from .protocols import Protocols
from .pipe_capturer import Pipe


class FeatureExtractor:
    """A class to extract related features for each protocol from a given list of pipes."""

    @staticmethod
    def execute(pipes: List[Pipe], floating_point_unit: str, features_ignore_list: List = [],
                label: str = "") -> List:
        """
        Extract features from a list of pipes.

        Args:
            pipes: A list of Pipe objects to extract features from.
            floating_point_unit: A string indicating the unit to use for floating-point features.
            features_ignore_list: A list of feature names to ignore during extraction.
            label: A string label to assign to all extracted features.

        Returns:
            A list of dictionaries representing the extracted features, one for each Pipe object in `pipes`.
        """

        features = {
            Protocols.Zwave: [
                ZwaveFlowHomeID(),
                ZwaveFlowSrcID(),
                ZwaveFlowDstID(),
                Duration(),
                PacketsCount(),
                AverageSpeed(),
                MedianSpeed(),
                ModeSpeed(),
                StdDevSpeed(),
                MinSpeed(),
                MaxSpeed(),
                SpeedRange(),
                SpeedVariance(),
                CoeffVariationSpeed(),
                SpeedSkewness(),
                FwdAverageSpeed(),
                FwdMedianSpeed(),
                FwdModeSpeed(),
                FwdStdDevSpeed(),
                FwdMinSpeed(),
                FwdMaxSpeed(),
                FwdSpeedRange(),
                FwdSpeedVariance(),
                FwdCoeffVariationSpeed(),
                FwdSpeedSkewness(),
                BwdAverageSpeed(),
                BwdMedianSpeed(),
                BwdModeSpeed(),
                BwdStdDevSpeed(),
                BwdMinSpeed(),
                BwdMaxSpeed(),
                BwdSpeedRange(),
                BwdSpeedVariance(),
                BwdCoeffVariationSpeed(),
                BwdSpeedSkewness(),
                CountEachPacketClass(),
                ProportionEachPacketClass(),
                ProportionEachApplicationType(),
                FwdCountEachPacketClass(),
                FwdProportionEachPacketClass(),
                FwdProportionEachApplicationType(),
                BwdCountEachPacketClass(),
                BwdProportionEachPacketClass(),
                BwdProportionEachApplicationType(),
                AverageRSSI(),
                MedianRSSI(),
                ModeRSSI(),
                StdDevRSSI(),
                MinRSSI(),
                MaxRSSI(),
                RSSIRange(),
                RSSIVariance(),
                CoeffVariationSpeed(),
                RSSISkewness(),
                RSSIKurtosis(),
                FwdAverageRSSI(),
                FwdMedianRSSI(),
                FwdModeRSSI(),
                FwdStdDevRSSI(),
                FwdMinRSSI(),
                FwdMaxRSSI(),
                FwdRSSIRange(),
                FwdRSSIVariance(),
                FwdCoeffVariationSpeed(),
                FwdRSSISkewness(),
                FwdRSSIKurtosis(),
                BwdAverageRSSI(),
                BwdMedianRSSI(),
                BwdModeRSSI(),
                BwdStdDevRSSI(),
                BwdMinRSSI(),
                BwdMaxRSSI(),
                BwdRSSIRange(),
                BwdRSSIVariance(),
                BwdCoeffVariationSpeed(),
                BwdRSSISkewness(),
                BwdRSSIKurtosis(),
                TotalAcknowledgments(),
                ProportionAcknowledgedPackets(),
                TotalCRCErrors(),
                ProportionCRCErrors(),
                TotalSubstitutedPackets(),
                ProportionSubstitutedPackets(),
                CountPacketsWithUnknownHeaders(),
                ProportionUnknownHeaderPackets(),
                CountWakeupBeams(),
                ProportionWakeupBeamPackets(),
                UniqueHexPatternsCount(),
                FrequencyOfTopHexPatterns(),
                EntropyOfHexData(),
                HexDataPatternLengthVariability(),
                CrossCorrelationSpeedRSSI(),
                TimeSeriesAnalysisPacketIntervals(),
                PercentagePacketsPerChannel(),
                PercentageHighSpeedTransmissions(),
                TotalLowSignalPackets(),
                PercentageLowSignalPackets(),
                AverageChannelUsage(),
                MostCommonChannel(),
                LeastCommonChannel(),
                ChannelTransitionCount(),
                ChannelStability(),
                EntropyOfChannelUsage(),
                CommonDataPatterns(),
                UniqueDataEntries(),
                ClassDistribution(),
                MostCommonClass(),
                LeastCommonClass(),
                ApplicationUsageFrequency(),
                MostCommonApplication(),
                UniqueApplicationCount(),
                HeaderPatternConsistency(),
                HeaderComplexity(),
                PayloadToHeaderRatio(),
                IncrementalDataChange(),
                HeaderEntropy(),
                TemporalStabilityOfClassType(),
                TemporalStabilityOfApplicationType(),
                DataFieldEntropy(),
                PayloadEntropy(),
                CountOfSingleCastPackets(),
                ProportionOfSingleCastPackets(),
                CountOfACKPackets(),
                ProportionOfACKPackets(),
                CountOfMulticastPackets(),
                ProportionOfMulticastPackets(),
                CountOfBroadcastPackets(),
                ProportionOfBroadcastPackets(),
                CountOfExplorerAutoInclusionPackets(),
                ProportionOfExplorerAutoInclusionPackets(),
                FwdTotalAcknowledgments(),
                FwdProportionAcknowledgedPackets(),
                FwdTotalCRCErrors(),
                FwdProportionCRCErrors(),
                FwdTotalSubstitutedPackets(),
                FwdProportionSubstitutedPackets(),
                FwdCountPacketsWithUnknownHeaders(),
                FwdProportionUnknownHeaderPackets(),
                FwdCountWakeupBeams(),
                FwdProportionWakeupBeamPackets(),
                FwdUniqueHexPatternsCount(),
                FwdFrequencyOfTopHexPatterns(),
                FwdEntropyOfHexData(),
                FwdHexDataPatternLengthVariability(),
                FwdCrossCorrelationSpeedRSSI(),
                FwdTimeSeriesAnalysisPacketIntervals(),
                FwdPercentagePacketsPerChannel(),
                FwdPercentageHighSpeedTransmissions(),
                FwdTotalLowSignalPackets(),
                FwdPercentageLowSignalPackets(),
                FwdAverageChannelUsage(),
                FwdMostCommonChannel(),
                FwdLeastCommonChannel(),
                FwdChannelTransitionCount(),
                FwdChannelStability(),
                FwdEntropyOfChannelUsage(),
                FwdCommonDataPatterns(),
                FwdUniqueDataEntries(),
                FwdClassDistribution(),
                FwdMostCommonClass(),
                FwdLeastCommonClass(),
                FwdApplicationUsageFrequency(),
                FwdMostCommonApplication(),
                FwdUniqueApplicationCount(),
                FwdHeaderPatternConsistency(),
                FwdHeaderComplexity(),
                FwdPayloadToHeaderRatio(),
                FwdIncrementalDataChange(),
                FwdHeaderEntropy(),
                FwdTemporalStabilityOfClassType(),
                FwdTemporalStabilityOfApplicationType(),
                FwdDataFieldEntropy(),
                FwdPayloadEntropy(),
                FwdCountOfSingleCastPackets(),
                FwdProportionOfSingleCastPackets(),
                FwdCountOfACKPackets(),
                FwdProportionOfACKPackets(),
                FwdCountOfMulticastPackets(),
                FwdProportionOfMulticastPackets(),
                FwdCountOfBroadcastPackets(),
                FwdProportionOfBroadcastPackets(),
                FwdCountOfExplorerAutoInclusionPackets(),
                FwdProportionOfExplorerAutoInclusionPackets(),
                BwdTotalAcknowledgments(),
                BwdProportionAcknowledgedPackets(),
                BwdTotalCRCErrors(),
                BwdProportionCRCErrors(),
                BwdTotalSubstitutedPackets(),
                BwdProportionSubstitutedPackets(),
                BwdCountPacketsWithUnknownHeaders(),
                BwdProportionUnknownHeaderPackets(),
                BwdCountWakeupBeams(),
                BwdProportionWakeupBeamPackets(),
                BwdUniqueHexPatternsCount(),
                BwdFrequencyOfTopHexPatterns(),
                BwdEntropyOfHexData(), 
                BwdHexDataPatternLengthVariability(),
                BwdCrossCorrelationSpeedRSSI(),
                BwdTimeSeriesAnalysisPacketIntervals(),
                BwdPercentagePacketsPerChannel(),
                BwdPercentageHighSpeedTransmissions(),
                BwdTotalLowSignalPackets(),
                BwdPercentageLowSignalPackets(),
                BwdAverageChannelUsage(),
                BwdMostCommonChannel(),
                BwdLeastCommonChannel(),
                BwdChannelTransitionCount(),
                BwdChannelStability(),
                BwdEntropyOfChannelUsage(),
                BwdCommonDataPatterns(),
                BwdUniqueDataEntries(),
                BwdClassDistribution(),
                BwdMostCommonClass(),
                BwdLeastCommonClass(),
                BwdApplicationUsageFrequency(),
                BwdMostCommonApplication(),
                BwdUniqueApplicationCount(),
                BwdHeaderPatternConsistency(),
                BwdHeaderComplexity(),
                BwdPayloadToHeaderRatio(),
                BwdIncrementalDataChange(),
                BwdHeaderEntropy(),
                BwdTemporalStabilityOfClassType(),
                BwdTemporalStabilityOfApplicationType(),
                BwdDataFieldEntropy(),
                BwdPayloadEntropy(),
                BwdCountOfSingleCastPackets(),
                BwdProportionOfSingleCastPackets(),
                BwdCountOfACKPackets(),
                BwdProportionOfACKPackets(),
                BwdCountOfMulticastPackets(),
                BwdProportionOfMulticastPackets(),
                BwdCountOfBroadcastPackets(),
                BwdProportionOfBroadcastPackets(),
                BwdCountOfExplorerAutoInclusionPackets(),
                BwdProportionOfExplorerAutoInclusionPackets(),
                TotalHeaderBytes(),
                MaxHeaderBytes(),
                MinHeaderBytes(),
                MeanHeaderBytes(),
                ModeHeaderBytes(),
                VarianceHeaderBytes(),
                StandardDeviationHeaderBytes(),
                MedianHeaderBytes(),
                SkewnessHeaderBytes(),
                CoefficientOfVariationHeaderBytes(),
                MaxPayloadBytes(),
                TotalPayloadBytes(),
                MinPayloadBytes(),
                MeanPayloadBytes(),
                ModePayloadBytes(),
                VariancePayloadBytes(),
                StandardDeviationPayloadBytes(),
                MedianPayloadBytes(),
                SkewnessPayloadBytes(),
                CoefficientOfVariationPayloadBytes(),
                TotalPacketLen(),
                MaxPacketLen(),
                MinPacketLen(),
                MeanPacketLen(),
                ModePacketLen(),
                VariancePacketLen(),
                StandardDeviationPacketLen(),
                MedianPacketLen(),
                SkewnessPacketLen(),
                CoefficientOfVariationPacketLen(),
                TotalDataFieldSize(),
                MaxDataFieldSize(),
                MinDataFieldSize(),
                MeanDataFieldSize(),
                ModeDataFieldSize(),
                VarianceDataFieldSize(),
                StdDataFieldSize(),
                SkewnessDataFieldSize(),
                CoefficientOfVariationDataFieldSize(),
                MedianDataFieldSize(),
                FwdTotalHeaderBytes(),
                FwdMaxHeaderBytes(),
                FwdMinHeaderBytes(),
                FwdMeanHeaderBytes(),
                FwdModeHeaderBytes(),
                FwdVarianceHeaderBytes(),
                FwdStandardDeviationHeaderBytes(),
                FwdMedianHeaderBytes(),
                FwdSkewnessHeaderBytes(),
                FwdCoefficientOfVariationHeaderBytes(),
                FwdMaxPayloadBytes(),
                FwdTotalPayloadBytes(),
                FwdMinPayloadBytes(),
                FwdMeanPayloadBytes(),
                FwdModePayloadBytes(),
                FwdVariancePayloadBytes(),
                FwdStandardDeviationPayloadBytes(),
                FwdMedianPayloadBytes(),
                FwdSkewnessPayloadBytes(),
                FwdCoefficientOfVariationPayloadBytes(),
                FwdTotalPacketLen(),
                FwdMaxPacketLen(),
                FwdMinPacketLen(),
                FwdMeanPacketLen(),
                FwdModePacketLen(),
                FwdVariancePacketLen(),
                FwdStandardDeviationPacketLen(),
                FwdMedianPacketLen(),
                FwdSkewnessPacketLen(),
                FwdCoefficientOfVariationPacketLen(),
                FwdTotalDataFieldSize(),
                FwdMaxDataFieldSize(),
                FwdMinDataFieldSize(),
                FwdMeanDataFieldSize(),
                FwdModeDataFieldSize(),
                FwdVarianceDataFieldSize(),
                FwdStdDataFieldSize(),
                FwdSkewnessDataFieldSize(),
                FwdCoefficientOfVariationDataFieldSize(),
                FwdMedianDataFieldSize(),
                BwdTotalHeaderBytes(),
                BwdMaxHeaderBytes(),
                BwdMinHeaderBytes(),
                BwdMeanHeaderBytes(),
                BwdModeHeaderBytes(),
                BwdVarianceHeaderBytes(),
                BwdStandardDeviationHeaderBytes(),
                BwdMedianHeaderBytes(),
                BwdSkewnessHeaderBytes(),
                BwdCoefficientOfVariationHeaderBytes(),
                BwdMaxPayloadBytes(),
                BwdTotalPayloadBytes(),
                BwdMinPayloadBytes(),
                BwdMeanPayloadBytes(),
                BwdModePayloadBytes(),
                BwdVariancePayloadBytes(),
                BwdStandardDeviationPayloadBytes(),
                BwdMedianPayloadBytes(),
                BwdSkewnessPayloadBytes(),
                BwdCoefficientOfVariationPayloadBytes(),
                BwdTotalPacketLen(),
                BwdMaxPacketLen(),
                BwdMinPacketLen(),
                BwdMeanPacketLen(),
                BwdModePacketLen(),
                BwdVariancePacketLen(),
                BwdStandardDeviationPacketLen(),
                BwdMedianPacketLen(),
                BwdSkewnessPacketLen(),
                BwdCoefficientOfVariationPacketLen(),
                BwdTotalDataFieldSize(),
                BwdMaxDataFieldSize(),
                BwdMinDataFieldSize(),
                BwdMeanDataFieldSize(),
                BwdModeDataFieldSize(),
                BwdVarianceDataFieldSize(),
                BwdStdDataFieldSize(),
                BwdSkewnessDataFieldSize(),
                BwdCoefficientOfVariationDataFieldSize(),
                BwdMedianDataFieldSize(),
                HeaderBytesRate(),
                PayloadBytesRate(),
                PacketLenRate(),
                PacketsRate(),
                FwdPacketsCount(),
                FwdHeaderBytesRate(),
                FwdPayloadBytesRate(),
                FwdPacketLenRate(),
                FwdPacketsRate(),
                BwdPacketsCount(),
                BwdHeaderBytesRate(),
                BwdPayloadBytesRate(),
                BwdPacketLenRate(),
                BwdPacketsRate(),
                MaxPacketsTimeDelta(),
                MinPacketsTimeDelta(),
                MeanPacketsTimeDelta(),
                ModePacketsTimeDelta(),
                VariancePacketsTimeDelta(),
                StandardDeviationPacketsTimeDelta(),
                MedianPacketsTimeDelta(),
                SkewnessPacketsTimeDelta(),
                CoefficientOfVariationPacketsTimeDelta(),
                FwdMaxPacketsTimeDelta(),
                FwdMinPacketsTimeDelta(),
                FwdMeanPacketsTimeDelta(),
                FwdModePacketsTimeDelta(),
                FwdVariancePacketsTimeDelta(),
                FwdStandardDeviationPacketsTimeDelta(),
                FwdMedianPacketsTimeDelta(),
                FwdSkewnessPacketsTimeDelta(),
                FwdCoefficientOfVariationPacketsTimeDelta(),
                BwdMaxPacketsTimeDelta(),
                BwdMinPacketsTimeDelta(),
                BwdMeanPacketsTimeDelta(),
                BwdModePacketsTimeDelta(),
                BwdVariancePacketsTimeDelta(),
                BwdStandardDeviationPacketsTimeDelta(),
                BwdMedianPacketsTimeDelta(),
                BwdSkewnessPacketsTimeDelta(),
                BwdCoefficientOfVariationPacketsTimeDelta(),

            ],
            Protocols.EtherCAT: [
                EtherCATDuration(),
                PacketsCount(),
                EtherCATHeaderBytesRate(),
                EtherCATPayloadBytesRate(),
                EtherCATPacketLenRate(),
                EtherCatPacketsRate(),
                EtherCATMaxHeaderBytes(),
                EtherCATTotalHeaderBytes(),
                EtherCATMinHeaderBytes(),
                EtherCATMeanHeaderBytes(),
                EtherCATModeHeaderBytes(),
                EtherCATVarianceHeaderBytes(),
                EtherCATStandardDeviationHeaderBytes(),
                EtherCATMedianHeaderBytes(),
                EtherCATSkewnessHeaderBytes(),
                EtherCATCoefficientOfVariationHeaderBytes(),
                EtherCATMaxPayloadBytes(),
                EtherCATTotalPayloadBytes(),
                EtherCATMinPayloadBytes(),
                EtherCATMeanPayloadBytes(),
                EtherCATModePayloadBytes(),
                EtherCATVariancePayloadBytes(),
                EtherCATStandardDeviationPayloadBytes(),
                EtherCATMedianPayloadBytes(),
                EtherCATSkewnessPayloadBytes(),
                EtherCATCoefficientOfVariationPayloadBytes(),
                EtherCATMaxPacketLen(),
                EtherCATTotalPacketLen(),
                EtherCATMinPacketLen(),
                EtherCATMeanPacketLen(),
                EtherCATModePacketLen(),
                EtherCATVariancePacketLen(),
                EtherCATStandardDeviationPacketLen(),
                EtherCATMedianPacketLen(),
                EtherCATSkewnessPacketLen(),
                EtherCATCoefficientOfVariationPacketLen(),
                EtherCATMaxPacketsTimeDelta(),
                EtherCATMinPacketsTimeDelta(),
                EtherCATMeanPacketsTimeDelta(),
                EtherCATModePacketsTimeDelta(),
                EtherCATVariancePacketsTimeDelta(),
                EtherCATStandardDeviationPacketsTimeDelta(),
                EtherCATMedianPacketsTimeDelta(),
                EtherCATSkewnessPacketsTimeDelta(),
                EtherCATCoefficientOfVariationPacketsTimeDelta(),
                EtherCATTotalDataLen(),
                EtherCATMaxDataLen(),
                EtherCATMinDataLen(),
                EtherCATMeanDataLen(),
                EtherCATModeDataLen(),
                EtherCATVarianceDataLen(),
                EtherCATStandardDeviationDataLen(),
                EtherCATMedianDataLen(),
                EtherCATSkewnessDataLen(),
                EtherCATCoefficientOfVariationDataLen(),
                EtherCATNumberOfUniqueCommands(),
                EtherCATUniqueCommands(),
                EtherCATNumberOfNOPCommands(),
                EtherCATNumberOfAPRDCommands(),
                EtherCATNumberOfAPWRCommands(),
                EtherCATNumberOfAPRWCommands(),
                EtherCATNumberOfFPRDCommands(),
                EtherCATNumberOfFPWRCommands(),
                EtherCATNumberOfFPRWCommands(),
                EtherCATNumberOfBRDCommands(),
                EtherCATNumberOfBWRCommands(),
                EtherCATNumberOfBRWCommands(),
                EtherCATNumberOfLRDCommands(),
                EtherCATNumberOfLWRCommands(),
                EtherCATNumberOfLRWCommands(),
                EtherCATNumberOfARMWCommands(),
                EtherCATNumberOfDuplicateIndices(),
                EtherCATNumberOfCirculatingDatagrams(),
                EtherCATNumberOfCirculatingDatagrams(),
                EtherCATNumberOfLastDatagrams(),
                EtherCATNumberOfNotLastDatagrams(),
                EtherCATUniqueInterruptRequestsValues(),
                EtherCATUniqueWorkingCounterValues(),
                # EtherCATDataValues(),
            ]
        }

        extracted_data = {
            Protocols.Zwave: [],
            Protocols.EtherCAT: []
        }
        for pipe in pipes:
            features_of_pipe = {
                "flow_id": str(pipe),
                "timestamp": str(pipe.get_timestamp()),
                "protocol": str(pipe.get_protocol())
            }

            for feature in features[pipe.get_protocol()]:
                if feature.name in features_ignore_list:
                    continue
                feature.set_floating_point_unit(floating_point_unit)
                features_of_pipe[feature.name] = feature.extract(pipe)
            features_of_pipe["label"] = label
            extracted_data[pipe.get_protocol()].append(features_of_pipe)

        return extracted_data
